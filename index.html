<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LUCAS Agent</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#050505">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LUCAS">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-512.png">
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Urbanist', sans-serif; background: #050505; color: white; min-height: 100vh; min-height: -webkit-fill-available; overflow-x: hidden; }
        html { height: -webkit-fill-available; }
        #root { min-height: 100vh; min-height: -webkit-fill-available; display: flex; flex-direction: column; }
        .lucas-green { color: #deff9a; }
        .bg-lucas-green { background: #deff9a; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes success-pop { 0% { transform: scale(0); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        .success-pop { animation: success-pop 0.5s ease-out; }
        .safe-top { padding-top: env(safe-area-inset-top, 20px); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .spinner { width: 40px; height: 40px; border: 3px solid #262626; border-top-color: #deff9a; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .btn-press:active { transform: scale(0.97); }
        input, select, textarea { font-family: 'Urbanist', sans-serif; }
        .input-field { width: 100%; padding: 16px; background: #1a1a1a; border: 1px solid #262626; border-radius: 12px; color: white; font-size: 16px; outline: none; transition: border-color 0.2s; }
        .input-field:focus { border-color: #deff9a; }
        .input-field::placeholder { color: #6b7280; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/lucas-pwa/sw.js').catch(e => console.log('SW failed:', e));
            });
        }
    </script>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // SUPABASE CONFIG
        const SUPABASE_URL = 'https://irztntmenxchzicfegid.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlyenRudG1lbnhjaHppY2ZlZ2lkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxMTA4ODQsImV4cCI6MjA3OTY4Njg4NH0.EjaO-HXjzElo_eHqEWzagsqGg-gEVqUxY1ri-MhofPw';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // WhatsApp Support Button
        function WhatsAppButton() {
            const openWhatsApp = () => {
                window.open('https://wa.me/971585072588?text=Hola!%20Necesito%20ayuda%20con%20LUCAS', '_blank');
            };
            return (
                <button onClick={openWhatsApp} style={{ position: 'fixed', bottom: '90px', right: '20px', width: '56px', height: '56px', borderRadius: '50%', background: '#25D366', border: 'none', boxShadow: '0 4px 12px rgba(0,0,0,0.3)', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 99 }}>
                    <i className="fa-brands fa-whatsapp" style={{ fontSize: '28px', color: 'white' }}></i>
                </button>
            );
        }
        
        // Welcome Screen
        function WelcomeScreen({ setScreen }) {
            return (
                <div className="fade-in" style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', minHeight: '100vh', padding: '40px 20px', textAlign: 'center', background: 'radial-gradient(ellipse at center top, rgba(222,255,154,0.08) 0%, transparent 50%)' }}>
                    {/* Logo */}
                    <div style={{ marginBottom: '32px' }}>
                        <img src="icon-512.png" alt="LUCAS" style={{ width: '120px', height: '120px', borderRadius: '28px' }} />
                    </div>
                    
                    {/* Brand Name */}
                    <h1 style={{ fontSize: '42px', fontWeight: 800, marginBottom: '8px', letterSpacing: '-1px' }}>LUCAS</h1>
                    
                    {/* Tagline */}
                    <p style={{ color: '#deff9a', fontSize: '14px', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '2px', marginBottom: '8px' }}>The API for Reality</p>
                    <p style={{ color: '#6b7280', fontSize: '16px', marginBottom: '48px', maxWidth: '280px' }}>Gana USDT verificando el mundo real</p>
                    
                    {/* Stats */}
                    <div style={{ display: 'flex', gap: '24px', marginBottom: '40px' }}>
                        <div style={{ textAlign: 'center' }}>
                            <div style={{ fontSize: '24px', fontWeight: 800, color: '#deff9a' }}>$2-5</div>
                            <div style={{ fontSize: '11px', color: '#6b7280', textTransform: 'uppercase' }}>Por tarea</div>
                        </div>
                        <div style={{ width: '1px', background: '#262626' }}></div>
                        <div style={{ textAlign: 'center' }}>
                            <div style={{ fontSize: '24px', fontWeight: 800, color: '#deff9a' }}>5 min</div>
                            <div style={{ fontSize: '11px', color: '#6b7280', textTransform: 'uppercase' }}>Promedio</div>
                        </div>
                        <div style={{ width: '1px', background: '#262626' }}></div>
                        <div style={{ textAlign: 'center' }}>
                            <div style={{ fontSize: '24px', fontWeight: 800, color: '#deff9a' }}>USDT</div>
                            <div style={{ fontSize: '11px', color: '#6b7280', textTransform: 'uppercase' }}>Pago</div>
                        </div>
                    </div>
                    
                    {/* CTA Buttons */}
                    <button onClick={() => setScreen('signup')} className="btn-press" style={{ width: '100%', maxWidth: '300px', padding: '18px', background: '#deff9a', color: '#050505', border: 'none', borderRadius: '14px', fontSize: '17px', fontWeight: 700, cursor: 'pointer', marginBottom: '12px', boxShadow: '0 0 30px rgba(222,255,154,0.2)' }}>Crear Cuenta</button>
                    <button onClick={() => setScreen('login')} className="btn-press" style={{ width: '100%', maxWidth: '300px', padding: '18px', background: 'transparent', color: 'white', border: '1px solid #262626', borderRadius: '14px', fontSize: '17px', fontWeight: 600, cursor: 'pointer' }}>Ya tengo cuenta</button>
                    
                    {/* Footer */}
                    <div style={{ marginTop: '48px', color: '#4b5563', fontSize: '12px' }}>
                        Piloto activo en CDMX üá≤üáΩ
                    </div>
                </div>
            );
        }
        
        // Signup Screen
        function SignupScreen({ setScreen, setAgent }) {
            const [name, setName] = useState('');
            const [phone, setPhone] = useState('');
            const [colonia, setColonia] = useState('');
            const [pin, setPin] = useState('');
            const [confirmPin, setConfirmPin] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState('');
            
            const handleSignup = async () => {
                setError('');
                if (!name.trim()) { setError('Ingresa tu nombre'); return; }
                if (!phone.trim() || phone.length < 10) { setError('Ingresa un n√∫mero de tel√©fono v√°lido'); return; }
                if (pin.length !== 4) { setError('El PIN debe ser de 4 d√≠gitos'); return; }
                if (pin !== confirmPin) { setError('Los PINs no coinciden'); return; }
                
                setIsLoading(true);
                try {
                    const { data: existing } = await supabase.from('agents').select('id').eq('phone', phone).single();
                    if (existing) { setError('Este n√∫mero ya est√° registrado'); setIsLoading(false); return; }
                    
                    const { data, error: insertError } = await supabase.from('agents').insert([{ name, phone, colonia, pin }]).select().single();
                    if (insertError) throw insertError;
                    
                    localStorage.setItem('lucas_agent', JSON.stringify(data));
                    setAgent(data);
                    setScreen('tasks');
                } catch (err) {
                    console.error('Signup error:', err);
                    setError('Error al crear cuenta. Intenta de nuevo.');
                }
                setIsLoading(false);
            };
            
            return (
                <div className="fade-in" style={{ minHeight: '100vh', padding: '20px', paddingTop: 'max(40px, env(safe-area-inset-top))' }}>
                    <button onClick={() => setScreen('welcome')} style={{ display: 'flex', alignItems: 'center', gap: '8px', color: '#9ca3af', fontSize: '14px', background: 'none', border: 'none', marginBottom: '24px', cursor: 'pointer' }}>
                        <i className="fa-solid fa-chevron-left"></i><span>Atr√°s</span>
                    </button>
                    <h1 style={{ fontSize: '28px', fontWeight: 700, marginBottom: '8px' }}>Crear Cuenta</h1>
                    <p style={{ color: '#6b7280', marginBottom: '32px' }}>Reg√≠strate para empezar a ganar</p>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                        <div><label style={{ fontSize: '14px', color: '#9ca3af', marginBottom: '8px', display: 'block' }}>Nombre completo</label><input type="text" className="input-field" placeholder="Tu nombre" value={name} onChange={(e) => setName(e.target.value)} /></div>
                        <div><label style={{ fontSize: '14px', color: '#9ca3af', marginBottom: '8px', display: 'block' }}>N√∫mero de WhatsApp</label><input type="tel" className="input-field" placeholder="55 1234 5678" value={phone} onChange={(e) => setPhone(e.target.value.replace(/\D/g, ''))} /></div>
                        <div><label style={{ fontSize: '14px', color: '#9ca3af', marginBottom: '8px', display: 'block' }}>Colonia (opcional)</label><input type="text" className="input-field" placeholder="Tu colonia en CDMX" value={colonia} onChange={(e) => setColonia(e.target.value)} /></div>
                        <div><label style={{ fontSize: '14px', color: '#9ca3af', marginBottom: '8px', display: 'block' }}>Crea un PIN de 4 d√≠gitos</label><input type="password" inputMode="numeric" maxLength={4} className="input-field" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value={pin} onChange={(e) => setPin(e.target.value.replace(/\D/g, ''))} style={{ letterSpacing: '8px', textAlign: 'center' }} /></div>
                        <div><label style={{ fontSize: '14px', color: '#9ca3af', marginBottom: '8px', display: 'block' }}>Confirma tu PIN</label><input type="password" inputMode="numeric" maxLength={4} className="input-field" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value={confirmPin} onChange={(e) => setConfirmPin(e.target.value.replace(/\D/g, ''))} style={{ letterSpacing: '8px', textAlign: 'center' }} /></div>
                        {error && <div style={{ background: 'rgba(239, 68, 68, 0.1)', border: '1px solid rgba(239, 68, 68, 0.3)', borderRadius: '8px', padding: '12px', color: '#ef4444', fontSize: '14px' }}>{error}</div>}
                        <button onClick={handleSignup} disabled={isLoading} className="btn-press" style={{ width: '100%', padding: '16px', background: isLoading ? '#666' : '#deff9a', color: '#050505', border: 'none', borderRadius: '12px', fontSize: '16px', fontWeight: 700, cursor: isLoading ? 'wait' : 'pointer', marginTop: '8px', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px' }}>
                            {isLoading ? <><div className="spinner" style={{ width: '20px', height: '20px', borderWidth: '2px' }}></div>Creando...</> : 'Crear Cuenta'}
                        </button>
                    </div>
                </div>
            );
        }
        
        // Login Screen
        function LoginScreen({ setScreen, setAgent }) {
            const [phone, setPhone] = useState('');
            const [pin, setPin] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState('');
            
            const handleLogin = async () => {
                setError('');
                if (!phone.trim() || phone.length < 10) { setError('Ingresa tu n√∫mero de tel√©fono'); return; }
                if (pin.length !== 4) { setError('Ingresa tu PIN de 4 d√≠gitos'); return; }
                
                setIsLoading(true);
                try {
                    const { data, error: fetchError } = await supabase.from('agents').select('*').eq('phone', phone).eq('pin', pin).single();
                    if (fetchError || !data) { setError('N√∫mero o PIN incorrecto'); setIsLoading(false); return; }
                    
                    localStorage.setItem('lucas_agent', JSON.stringify(data));
                    setAgent(data);
                    setScreen('tasks');
                } catch (err) {
                    console.error('Login error:', err);
                    setError('Error al iniciar sesi√≥n');
                }
                setIsLoading(false);
            };
            
            return (
                <div className="fade-in" style={{ minHeight: '100vh', padding: '20px', paddingTop: 'max(40px, env(safe-area-inset-top))' }}>
                    <button onClick={() => setScreen('welcome')} style={{ display: 'flex', alignItems: 'center', gap: '8px', color: '#9ca3af', fontSize: '14px', background: 'none', border: 'none', marginBottom: '24px', cursor: 'pointer' }}>
                        <i className="fa-solid fa-chevron-left"></i><span>Atr√°s</span>
                    </button>
                    <h1 style={{ fontSize: '28px', fontWeight: 700, marginBottom: '8px' }}>Iniciar Sesi√≥n</h1>
                    <p style={{ color: '#6b7280', marginBottom: '32px' }}>Ingresa con tu n√∫mero y PIN</p>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                        <div><label style={{ fontSize: '14px', color: '#9ca3af', marginBottom: '8px', display: 'block' }}>N√∫mero de WhatsApp</label><input type="tel" className="input-field" placeholder="55 1234 5678" value={phone} onChange={(e) => setPhone(e.target.value.replace(/\D/g, ''))} /></div>
                        <div><label style={{ fontSize: '14px', color: '#9ca3af', marginBottom: '8px', display: 'block' }}>Tu PIN</label><input type="password" inputMode="numeric" maxLength={4} className="input-field" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value={pin} onChange={(e) => setPin(e.target.value.replace(/\D/g, ''))} style={{ letterSpacing: '8px', textAlign: 'center' }} /></div>
                        {error && <div style={{ background: 'rgba(239, 68, 68, 0.1)', border: '1px solid rgba(239, 68, 68, 0.3)', borderRadius: '8px', padding: '12px', color: '#ef4444', fontSize: '14px' }}>{error}</div>}
                        <button onClick={handleLogin} disabled={isLoading} className="btn-press" style={{ width: '100%', padding: '16px', background: isLoading ? '#666' : '#deff9a', color: '#050505', border: 'none', borderRadius: '12px', fontSize: '16px', fontWeight: 700, cursor: isLoading ? 'wait' : 'pointer', marginTop: '8px', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px' }}>
                            {isLoading ? <><div className="spinner" style={{ width: '20px', height: '20px', borderWidth: '2px' }}></div>Entrando...</> : 'Entrar'}
                        </button>
                    </div>
                </div>
            );
        }
        
        // Bottom Navigation
        function BottomNav({ activeTab, setActiveTab, setScreen }) {
            const tabs = [{ id: 'tasks', icon: 'fa-list-check', label: 'Tareas' }, { id: 'wallet', icon: 'fa-wallet', label: 'Wallet' }, { id: 'profile', icon: 'fa-user', label: 'Perfil' }];
            return (
                <div className="safe-bottom" style={{ position: 'fixed', bottom: 0, left: 0, right: 0, height: '70px', background: '#111', borderTop: '1px solid #262626', display: 'flex', justifyContent: 'space-around', alignItems: 'center', zIndex: 100 }}>
                    {tabs.map(tab => (
                        <button key={tab.id} onClick={() => { setActiveTab(tab.id); setScreen(tab.id); }} className="btn-press" style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '4px', background: 'none', border: 'none', color: activeTab === tab.id ? '#deff9a' : '#6b7280', fontSize: '10px', cursor: 'pointer', padding: '8px 16px' }}>
                            <i className={`fa-solid ${tab.icon}`} style={{ fontSize: '20px' }}></i>
                            <span style={{ fontWeight: 500 }}>{tab.label}</span>
                        </button>
                    ))}
                </div>
            );
        }
        
        // Task Card
        function TaskCard({ task, onClick }) {
            const typeColors = { 'RETAIL': '#deff9a', 'MAPEO': '#60a5fa', 'KYB': '#f472b6' };
            return (
                <div onClick={onClick} className="btn-press fade-in" style={{ background: '#1a1a1a', border: '1px solid #262626', borderRadius: '12px', padding: '14px', marginBottom: '10px', cursor: 'pointer' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '8px' }}>
                        <span style={{ fontSize: '10px', color: typeColors[task.type], background: `${typeColors[task.type]}15`, padding: '3px 8px', borderRadius: '20px', fontWeight: 600 }}>{task.type}</span>
                        <span style={{ fontWeight: 700, color: '#deff9a' }}>${Number(task.payout).toFixed(2)}</span>
                    </div>
                    <div style={{ fontWeight: 600, fontSize: '15px', marginBottom: '6px' }}>{task.title}</div>
                    <div style={{ fontSize: '12px', color: '#6b7280', display: 'flex', alignItems: 'center', gap: '4px' }}><i className="fa-solid fa-location-dot"></i>{task.location}</div>
                </div>
            );
        }
        
        // Tasks Screen
        function TasksScreen({ agent, tasks, setScreen, setSelectedTask }) {
            return (
                <div className="fade-in" style={{ padding: '20px', paddingBottom: '90px' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                        <h2 style={{ fontSize: '22px', fontWeight: 700 }}>Hola, {agent.name.split(' ')[0]} üëã</h2>
                        <div style={{ width: '40px', height: '40px', background: '#262626', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#deff9a' }}><i className="fa-solid fa-user"></i></div>
                    </div>
                    <div style={{ background: 'linear-gradient(135deg, #1a1a1a 0%, #111 100%)', border: '1px solid #262626', borderRadius: '16px', padding: '16px', marginBottom: '24px' }}>
                        <div style={{ fontSize: '11px', color: '#6b7280', textTransform: 'uppercase', letterSpacing: '1px' }}>Tu Balance</div>
                        <div style={{ fontSize: '32px', fontWeight: 800, marginTop: '4px' }}>${Number(agent.balance || 0).toFixed(2)} <span style={{ color: '#deff9a', fontSize: '16px', fontWeight: 600 }}>USDT</span></div>
                        <div style={{ fontSize: '12px', color: '#6b7280', marginTop: '4px' }}>‚âà ${(Number(agent.balance || 0) * 17).toFixed(0)} MXN</div>
                    </div>
                    <div style={{ fontSize: '14px', fontWeight: 600, color: '#9ca3af', marginBottom: '12px' }}>Tareas Disponibles ({tasks.length})</div>
                    {tasks.length === 0 ? (
                        <div style={{ textAlign: 'center', padding: '40px 20px', color: '#6b7280' }}><i className="fa-solid fa-clipboard-check" style={{ fontSize: '48px', marginBottom: '16px', opacity: 0.5 }}></i><div>No hay tareas disponibles ahora</div></div>
                    ) : tasks.map(task => <TaskCard key={task.id} task={task} onClick={() => { setSelectedTask(task); setScreen('taskDetail'); }} />)}
                </div>
            );
        }
        
        // Task Detail Screen
        function TaskDetailScreen({ task, setScreen, setActiveTab }) {
            const typeColors = { 'RETAIL': '#deff9a', 'MAPEO': '#60a5fa', 'KYB': '#f472b6' };
            const openMaps = () => window.open(`https://www.google.com/maps/dir/?api=1&destination=${task.lat},${task.lng}`, '_blank');
            return (
                <div className="fade-in" style={{ padding: '20px', paddingBottom: '90px' }}>
                    <button onClick={() => { setScreen('tasks'); setActiveTab('tasks'); }} style={{ display: 'flex', alignItems: 'center', gap: '8px', color: '#9ca3af', fontSize: '14px', background: 'none', border: 'none', marginBottom: '16px', cursor: 'pointer' }}><i className="fa-solid fa-chevron-left"></i><span>Tareas</span></button>
                    <div style={{ background: '#1a1a1a', border: '1px solid #262626', borderRadius: '16px', padding: '16px', marginBottom: '16px' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                            <span style={{ fontSize: '10px', color: typeColors[task.type], background: `${typeColors[task.type]}15`, padding: '3px 8px', borderRadius: '20px', fontWeight: 600 }}>{task.type}</span>
                            <span style={{ fontSize: '24px', fontWeight: 800, color: '#deff9a' }}>${Number(task.payout).toFixed(2)}</span>
                        </div>
                        <h1 style={{ fontSize: '20px', fontWeight: 700, marginBottom: '16px' }}>{task.title}</h1>
                        <div style={{ display: 'flex', alignItems: 'start', gap: '10px', fontSize: '13px' }}><i className="fa-solid fa-location-dot" style={{ color: '#deff9a', marginTop: '3px' }}></i><div><div style={{ color: '#6b7280', fontSize: '11px' }}>Ubicaci√≥n</div><div>{task.location}</div><div style={{ fontSize: '12px', color: '#6b7280' }}>{task.address}</div></div></div>
                    </div>
                    <div style={{ background: '#111', borderRadius: '12px', padding: '14px', marginBottom: '20px' }}>
                        <div style={{ fontWeight: 600, marginBottom: '10px', fontSize: '14px' }}>üìã Instrucciones</div>
                        {(task.instructions || []).map((instruction, index) => <div key={index} style={{ fontSize: '13px', color: '#d1d5db', padding: '6px 0', display: 'flex', gap: '8px' }}><span style={{ color: '#deff9a', fontWeight: 600 }}>{index + 1}.</span>{instruction}</div>)}
                    </div>
                    <button onClick={openMaps} className="btn-press" style={{ width: '100%', padding: '14px', background: '#262626', color: 'white', border: 'none', borderRadius: '12px', fontSize: '14px', fontWeight: 600, marginBottom: '10px', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px' }}><i className="fa-solid fa-route"></i>Abrir en Google Maps</button>
                    <button onClick={() => setScreen('camera')} className="btn-press" style={{ width: '100%', padding: '16px', background: '#deff9a', color: '#050505', border: 'none', borderRadius: '12px', fontSize: '15px', fontWeight: 700, cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px' }}><i className="fa-solid fa-camera"></i>Tomar Foto</button>
                </div>
            );
        }
        
        // Camera Screen
        function CameraScreen({ task, setScreen, setCapturedImage, setGpsData }) {
            const fileInputRef = useRef(null);
            const canvasRef = useRef(null);
            const [location, setLocation] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);
            
            useEffect(() => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => setLocation({ lat: position.coords.latitude.toFixed(4), lng: position.coords.longitude.toFixed(4) }),
                        () => setLocation({ lat: Number(task.lat).toFixed(4), lng: Number(task.lng).toFixed(4) }),
                        { enableHighAccuracy: true }
                    );
                }
            }, []);
            
            const handleFileSelect = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                setIsProcessing(true);
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = canvasRef.current;
                        let { width, height } = img;
                        if (width > 1920 || height > 1080) { const ratio = Math.min(1920 / width, 1080 / height); width *= ratio; height *= ratio; }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        const timestamp = new Date().toISOString().slice(0, 19).replace('T', ' ');
                        const lat = location?.lat || Number(task.lat).toFixed(4);
                        const lng = location?.lng || Number(task.lng).toFixed(4);
                        ctx.fillStyle = 'rgba(0,0,0,0.7)'; ctx.fillRect(10, height - 80, 320, 70);
                        ctx.fillStyle = '#deff9a'; ctx.font = 'bold 16px monospace'; ctx.fillText(`üìç ${lat}¬∞, ${lng}¬∞`, 20, height - 50);
                        ctx.fillStyle = 'white'; ctx.fillText(`üïê ${timestamp}`, 20, height - 25);
                        setCapturedImage(canvas.toDataURL('image/jpeg', 0.8));
                        setGpsData({ lat, lng, timestamp });
                        setIsProcessing(false);
                        setScreen('review');
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            };
            
            return (
                <div style={{ display: 'flex', flexDirection: 'column', height: '100vh', padding: '20px', paddingTop: 'max(20px, env(safe-area-inset-top))' }}>
                    <button onClick={() => setScreen('taskDetail')} style={{ display: 'flex', alignItems: 'center', gap: '8px', color: '#9ca3af', fontSize: '14px', background: 'none', border: 'none', marginBottom: '16px', cursor: 'pointer' }}><i className="fa-solid fa-chevron-left"></i><span>Cancelar</span></button>
                    <input ref={fileInputRef} type="file" accept="image/*" capture="environment" onChange={handleFileSelect} style={{ display: 'none' }} />
                    <canvas ref={canvasRef} style={{ display: 'none' }} />
                    <div style={{ flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', background: '#111', borderRadius: '16px', marginBottom: '16px', padding: '40px 20px', textAlign: 'center' }}>
                        {isProcessing ? <><div className="spinner" style={{ marginBottom: '16px' }}></div><div style={{ color: '#9ca3af' }}>Procesando foto...</div></> : <>
                            <div style={{ width: '100px', height: '100px', background: 'rgba(222, 255, 154, 0.1)', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center', marginBottom: '24px' }}><i className="fa-solid fa-camera" style={{ fontSize: '40px', color: '#deff9a' }}></i></div>
                            <h3 style={{ fontSize: '18px', fontWeight: 600, marginBottom: '8px' }}>Tomar Foto</h3>
                            <p style={{ color: '#6b7280', fontSize: '14px' }}>{task.instructions?.[2] || 'Toma una foto clara'}</p>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '6px', color: '#deff9a', fontSize: '12px', marginTop: '16px' }}><i className="fa-solid fa-location-dot"></i><span>GPS: {location ? `${location.lat}¬∞, ${location.lng}¬∞` : 'Obteniendo...'}</span></div>
                        </>}
                    </div>
                    <button onClick={() => fileInputRef.current?.click()} disabled={isProcessing} className="btn-press" style={{ width: '100%', padding: '18px', background: isProcessing ? '#333' : '#deff9a', color: '#050505', border: 'none', borderRadius: '12px', fontSize: '16px', fontWeight: 700, cursor: isProcessing ? 'wait' : 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '10px', marginBottom: '20px' }}><i className="fa-solid fa-camera"></i>Abrir C√°mara</button>
                </div>
            );
        }
        
        // Review Screen
        function ReviewScreen({ task, capturedImage, gpsData, setScreen, agent, setAgent, refreshTasks }) {
            const [isSubmitting, setIsSubmitting] = useState(false);
            
            const handleSubmit = async () => {
                setIsSubmitting(true);
                try {
                    // 1. Upload photo to Supabase Storage
                    const timestamp = Date.now();
                    const fileName = `${agent.id}/${task.id}_${timestamp}.jpg`;
                    
                    // Convert base64 to blob
                    const base64Data = capturedImage.split(',')[1];
                    const byteCharacters = atob(base64Data);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], { type: 'image/jpeg' });
                    
                    // Upload to storage
                    const { data: uploadData, error: uploadError } = await supabase.storage
                        .from('submissions')
                        .upload(fileName, blob, { contentType: 'image/jpeg' });
                    
                    if (uploadError) throw uploadError;
                    
                    // Get public URL
                    const { data: urlData } = supabase.storage.from('submissions').getPublicUrl(fileName);
                    const imageUrl = urlData.publicUrl;
                    
                    // 2. Create submission with image URL
                    await supabase.from('submissions').insert([{ 
                        task_id: task.id, 
                        agent_id: agent.id, 
                        gps_lat: parseFloat(gpsData.lat), 
                        gps_lng: parseFloat(gpsData.lng), 
                        image_url: imageUrl,
                        status: 'approved', 
                        payout: task.payout 
                    }]);
                    
                    // 3. Update task status
                    await supabase.from('tasks').update({ status: 'completed', assigned_to: agent.id }).eq('id', task.id);
                    
                    // 4. Update agent balance
                    const newBalance = Number(agent.balance || 0) + Number(task.payout);
                    const { data: updatedAgent } = await supabase.from('agents').update({ balance: newBalance, completed_tasks: (agent.completed_tasks || 0) + 1 }).eq('id', agent.id).select().single();
                    if (updatedAgent) { setAgent(updatedAgent); localStorage.setItem('lucas_agent', JSON.stringify(updatedAgent)); }
                    
                    // 5. Create transaction
                    await supabase.from('transactions').insert([{ agent_id: agent.id, type: 'earning', amount: task.payout, description: task.title, task_id: task.id }]);
                    await refreshTasks();
                    setScreen('success');
                } catch (err) { console.error('Submit error:', err); alert('Error al enviar. Intenta de nuevo.'); }
                setIsSubmitting(false);
            };
            
            return (
                <div className="fade-in" style={{ padding: '20px', paddingBottom: '40px' }}>
                    <h2 style={{ fontSize: '20px', fontWeight: 700, marginBottom: '20px' }}>Revisar Env√≠o</h2>
                    <div style={{ width: '100%', height: '200px', borderRadius: '12px', overflow: 'hidden', marginBottom: '16px', position: 'relative' }}>
                        <img src={capturedImage} alt="Captured" style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
                        <div style={{ position: 'absolute', top: '10px', right: '10px', background: '#deff9a', color: '#050505', fontSize: '11px', fontWeight: 600, padding: '4px 10px', borderRadius: '6px' }}><i className="fa-solid fa-check"></i> Foto capturada</div>
                    </div>
                    <div style={{ marginBottom: '20px' }}>
                        {[{ label: 'GPS verificado', value: `${gpsData.lat}¬∞, ${gpsData.lng}¬∞` }, { label: 'Timestamp', value: gpsData.timestamp + ' UTC' }, { label: 'Foto de alta calidad', value: 'Lista para enviar' }].map((item, i) => (
                            <div key={i} style={{ display: 'flex', alignItems: 'center', gap: '10px', padding: '12px 0', borderBottom: '1px solid #262626' }}><i className="fa-solid fa-circle-check" style={{ color: '#deff9a' }}></i><div><div style={{ fontSize: '14px' }}>{item.label}</div><div style={{ fontSize: '11px', color: '#6b7280' }}>{item.value}</div></div></div>
                        ))}
                    </div>
                    <button onClick={() => setScreen('camera')} className="btn-press" style={{ width: '100%', padding: '14px', background: '#262626', color: 'white', border: 'none', borderRadius: '12px', fontSize: '14px', fontWeight: 600, marginBottom: '10px', cursor: 'pointer' }}><i className="fa-solid fa-camera"></i> Tomar otra foto</button>
                    <button onClick={handleSubmit} disabled={isSubmitting} className="btn-press" style={{ width: '100%', padding: '16px', background: isSubmitting ? '#a3c261' : '#deff9a', color: '#050505', border: 'none', borderRadius: '12px', fontSize: '15px', fontWeight: 700, cursor: isSubmitting ? 'wait' : 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px' }}>
                        {isSubmitting ? <><div className="spinner" style={{ width: '20px', height: '20px', borderWidth: '2px' }}></div>Enviando...</> : <><i className="fa-solid fa-paper-plane"></i>Enviar Verificaci√≥n</>}
                    </button>
                </div>
            );
        }
        
        // Success Screen
        function SuccessScreen({ task, setScreen, setActiveTab, setSelectedTask }) {
            return (
                <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', minHeight: '100vh', padding: '40px 20px', textAlign: 'center' }}>
                    <div className="success-pop" style={{ width: '100px', height: '100px', background: 'rgba(222, 255, 154, 0.15)', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center', marginBottom: '24px' }}><i className="fa-solid fa-check" style={{ fontSize: '48px', color: '#deff9a' }}></i></div>
                    <h1 style={{ fontSize: '24px', fontWeight: 700, marginBottom: '8px' }}>¬°Verificaci√≥n Completa!</h1>
                    <p style={{ color: '#9ca3af', fontSize: '15px', marginBottom: '32px' }}>Tu pago est√° en camino</p>
                    <div style={{ fontSize: '48px', fontWeight: 800, color: '#deff9a', marginBottom: '4px' }}>+${Number(task.payout).toFixed(2)} USDT</div>
                    <div style={{ color: '#6b7280', fontSize: '13px', marginBottom: '40px' }}>Agregado a tu wallet</div>
                    <button onClick={() => { setSelectedTask(null); setActiveTab('tasks'); setScreen('tasks'); }} className="btn-press" style={{ width: '100%', maxWidth: '300px', padding: '16px', background: '#deff9a', color: '#050505', border: 'none', borderRadius: '12px', fontSize: '15px', fontWeight: 700, cursor: 'pointer', marginBottom: '12px' }}>Ver M√°s Tareas</button>
                    <button onClick={() => { setSelectedTask(null); setActiveTab('wallet'); setScreen('wallet'); }} className="btn-press" style={{ width: '100%', maxWidth: '300px', padding: '14px', background: '#262626', color: 'white', border: 'none', borderRadius: '12px', fontSize: '14px', fontWeight: 600, cursor: 'pointer' }}>Ir a Wallet</button>
                </div>
            );
        }
        
        // Wallet Screen
        function WalletScreen({ agent, transactions }) {
            return (
                <div className="fade-in" style={{ padding: '20px', paddingBottom: '90px' }}>
                    <h2 style={{ fontSize: '22px', fontWeight: 700, marginBottom: '20px' }}>Wallet</h2>
                    <div style={{ background: 'linear-gradient(135deg, #1a2f1a 0%, #111 100%)', border: '1px solid #2d4a2d', borderRadius: '20px', padding: '24px', textAlign: 'center', marginBottom: '20px' }}>
                        <div style={{ fontSize: '11px', color: '#6b7280', textTransform: 'uppercase', letterSpacing: '1px' }}>Balance Total</div>
                        <div style={{ fontSize: '40px', fontWeight: 800, margin: '8px 0' }}>${Number(agent.balance || 0).toFixed(2)} <span style={{ color: '#deff9a', fontSize: '18px' }}>USDT</span></div>
                        <div style={{ fontSize: '13px', color: '#6b7280' }}>‚âà ${(Number(agent.balance || 0) * 17).toFixed(0)} MXN</div>
                    </div>
                    <div style={{ display: 'flex', gap: '10px', marginBottom: '24px' }}>
                        <button className="btn-press" onClick={() => alert('Cash out disponible pr√≥ximamente')} style={{ flex: 1, padding: '14px', background: '#deff9a', color: '#050505', border: 'none', borderRadius: '12px', fontSize: '14px', fontWeight: 600, cursor: 'pointer' }}><i className="fa-solid fa-arrow-up"></i> Cash Out</button>
                        <button className="btn-press" style={{ flex: 1, padding: '14px', background: '#262626', color: 'white', border: 'none', borderRadius: '12px', fontSize: '14px', fontWeight: 600, cursor: 'pointer' }}><i className="fa-solid fa-clock-rotate-left"></i> Historial</button>
                    </div>
                    <div style={{ fontSize: '14px', fontWeight: 600, color: '#9ca3af', marginBottom: '12px' }}>Actividad Reciente</div>
                    {transactions.length === 0 ? <div style={{ textAlign: 'center', padding: '40px', color: '#6b7280' }}><i className="fa-solid fa-receipt" style={{ fontSize: '32px', marginBottom: '12px', opacity: 0.5 }}></i><div>Sin transacciones a√∫n</div></div> : 
                    transactions.map(tx => (
                        <div key={tx.id} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '14px 0', borderBottom: '1px solid #1a1a1a' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                <div style={{ width: '40px', height: '40px', background: tx.type === 'earning' ? 'rgba(222, 255, 154, 0.1)' : 'rgba(239, 68, 68, 0.1)', borderRadius: '10px', display: 'flex', alignItems: 'center', justifyContent: 'center', color: tx.type === 'earning' ? '#deff9a' : '#ef4444' }}><i className={`fa-solid ${tx.type === 'earning' ? 'fa-check' : 'fa-arrow-up'}`}></i></div>
                                <div><div style={{ fontWeight: 600, fontSize: '14px' }}>{tx.description}</div><div style={{ fontSize: '11px', color: '#6b7280' }}>{new Date(tx.created_at).toLocaleDateString('es-MX', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' })}</div></div>
                            </div>
                            <div style={{ fontWeight: 700, color: tx.type === 'earning' ? '#deff9a' : '#ef4444' }}>{tx.type === 'earning' ? '+' : '-'}${Math.abs(Number(tx.amount)).toFixed(2)}</div>
                        </div>
                    ))}
                </div>
            );
        }
        
        // Profile Screen
        function ProfileScreen({ agent, setAgent, setScreen }) {
            const handleLogout = () => { localStorage.removeItem('lucas_agent'); setAgent(null); setScreen('welcome'); };
            return (
                <div className="fade-in" style={{ padding: '20px', paddingBottom: '90px' }}>
                    <h2 style={{ fontSize: '22px', fontWeight: 700, marginBottom: '24px' }}>Perfil</h2>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '16px', marginBottom: '24px' }}>
                        <div style={{ width: '70px', height: '70px', background: 'linear-gradient(135deg, #deff9a 0%, #a3c261 100%)', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '28px', color: '#050505', fontWeight: 700 }}>{agent.name.charAt(0).toUpperCase()}</div>
                        <div><div style={{ fontSize: '20px', fontWeight: 700 }}>{agent.name}</div><div style={{ color: '#6b7280', fontSize: '14px' }}>{agent.phone}</div></div>
                    </div>
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '24px' }}>
                        <div style={{ background: '#1a1a1a', borderRadius: '12px', padding: '16px', textAlign: 'center' }}><div style={{ fontSize: '28px', fontWeight: 800, color: '#deff9a' }}>{agent.completed_tasks || 0}</div><div style={{ fontSize: '12px', color: '#6b7280' }}>Tareas completadas</div></div>
                        <div style={{ background: '#1a1a1a', borderRadius: '12px', padding: '16px', textAlign: 'center' }}><div style={{ fontSize: '28px', fontWeight: 800 }}>${Number(agent.balance || 0).toFixed(0)}</div><div style={{ fontSize: '12px', color: '#6b7280' }}>USDT ganados</div></div>
                    </div>
                    {[{ icon: 'fa-map-marker-alt', label: 'Colonia', value: agent.colonia || 'No especificada' }, { icon: 'fa-language', label: 'Idioma', value: 'Espa√±ol' }].map((item, i) => (
                        <div key={i} style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '14px 0', borderBottom: '1px solid #1a1a1a' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}><i className={`fa-solid ${item.icon}`} style={{ color: '#deff9a', width: '20px' }}></i><span>{item.label}</span></div>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px', color: '#6b7280' }}><span style={{ fontSize: '13px' }}>{item.value}</span><i className="fa-solid fa-chevron-right" style={{ fontSize: '12px' }}></i></div>
                        </div>
                    ))}
                    <button onClick={handleLogout} style={{ width: '100%', padding: '14px', background: 'transparent', color: '#ef4444', border: '1px solid rgba(239, 68, 68, 0.3)', borderRadius: '12px', fontSize: '14px', fontWeight: 600, marginTop: '24px', cursor: 'pointer' }}><i className="fa-solid fa-right-from-bracket"></i> Cerrar Sesi√≥n</button>
                    <div style={{ textAlign: 'center', marginTop: '24px', color: '#4b5563', fontSize: '12px' }}>LUCAS Agent v1.0.0 (Pilot)</div>
                </div>
            );
        }
        
        // Loading Screen
        function LoadingScreen() {
            return <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', minHeight: '100vh' }}><div className="spinner" style={{ marginBottom: '16px' }}></div><div style={{ color: '#6b7280' }}>Cargando...</div></div>;
        }
        
        // Main App
        function App() {
            const [isLoading, setIsLoading] = useState(true);
            const [agent, setAgent] = useState(null);
            const [tasks, setTasks] = useState([]);
            const [transactions, setTransactions] = useState([]);
            const [screen, setScreen] = useState('welcome');
            const [activeTab, setActiveTab] = useState('tasks');
            const [selectedTask, setSelectedTask] = useState(null);
            const [capturedImage, setCapturedImage] = useState(null);
            const [gpsData, setGpsData] = useState(null);
            
            useEffect(() => {
                const checkSession = async () => {
                    const saved = localStorage.getItem('lucas_agent');
                    if (saved) {
                        const agentData = JSON.parse(saved);
                        const { data } = await supabase.from('agents').select('*').eq('id', agentData.id).single();
                        if (data) { setAgent(data); localStorage.setItem('lucas_agent', JSON.stringify(data)); setScreen('tasks'); }
                    }
                    setIsLoading(false);
                };
                checkSession();
            }, []);
            
            const fetchTasks = async () => { const { data } = await supabase.from('tasks').select('*').eq('status', 'available').order('created_at', { ascending: false }); if (data) setTasks(data); };
            const fetchTransactions = async () => { if (!agent) return; const { data } = await supabase.from('transactions').select('*').eq('agent_id', agent.id).order('created_at', { ascending: false }).limit(20); if (data) setTransactions(data); };
            
            useEffect(() => { if (agent) { fetchTasks(); fetchTransactions(); } }, [agent]);
            
            if (isLoading) return <LoadingScreen />;
            
            const showBottomNav = agent && ['tasks', 'wallet', 'profile'].includes(screen);
            
            return (
                <div className="safe-top" style={{ minHeight: '100vh', background: '#050505' }}>
                    {screen === 'welcome' && !agent && <WelcomeScreen setScreen={setScreen} />}
                    {screen === 'signup' && <SignupScreen setScreen={setScreen} setAgent={setAgent} />}
                    {screen === 'login' && <LoginScreen setScreen={setScreen} setAgent={setAgent} />}
                    {screen === 'tasks' && agent && <TasksScreen agent={agent} tasks={tasks} setScreen={setScreen} setSelectedTask={setSelectedTask} />}
                    {screen === 'taskDetail' && selectedTask && <TaskDetailScreen task={selectedTask} setScreen={setScreen} setActiveTab={setActiveTab} />}
                    {screen === 'camera' && selectedTask && <CameraScreen task={selectedTask} setScreen={setScreen} setCapturedImage={setCapturedImage} setGpsData={setGpsData} />}
                    {screen === 'review' && selectedTask && capturedImage && <ReviewScreen task={selectedTask} capturedImage={capturedImage} gpsData={gpsData} setScreen={setScreen} agent={agent} setAgent={setAgent} refreshTasks={fetchTasks} />}
                    {screen === 'success' && selectedTask && <SuccessScreen task={selectedTask} setScreen={setScreen} setActiveTab={setActiveTab} setSelectedTask={setSelectedTask} />}
                    {screen === 'wallet' && agent && <WalletScreen agent={agent} transactions={transactions} />}
                    {screen === 'profile' && agent && <ProfileScreen agent={agent} setAgent={setAgent} setScreen={setScreen} />}
                    {showBottomNav && <WhatsAppButton />}
                    {showBottomNav && <BottomNav activeTab={activeTab} setActiveTab={setActiveTab} setScreen={setScreen} />}
                </div>
            );
        }
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
