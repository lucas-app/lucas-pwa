<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LUCAS Dashboard</title>
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Urbanist', sans-serif; background: #050505; color: white; min-height: 100vh; }
        
        /* Colors */
        :root {
            --lucas-green: #deff9a;
            --bg-dark: #050505;
            --bg-card: #111111;
            --bg-card-hover: #1a1a1a;
            --border: #262626;
            --text-muted: #6b7280;
            --text-light: #9ca3af;
        }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--lucas-green); border-radius: 50%; animation: spin 0.8s linear infinite; }
        
        /* Buttons */
        .btn { padding: 12px 24px; border: none; border-radius: 10px; font-family: inherit; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--lucas-green); color: #050505; }
        .btn-primary:hover { transform: scale(1.02); box-shadow: 0 0 20px rgba(222,255,154,0.3); }
        .btn-secondary { background: var(--bg-card-hover); color: white; border: 1px solid var(--border); }
        .btn-secondary:hover { border-color: var(--lucas-green); }
        .btn-sm { padding: 8px 16px; font-size: 13px; }
        .btn-icon { width: 40px; height: 40px; padding: 0; justify-content: center; border-radius: 10px; }
        
        /* Inputs */
        .input { width: 100%; padding: 14px 16px; background: var(--bg-card-hover); border: 1px solid var(--border); border-radius: 10px; color: white; font-family: inherit; font-size: 15px; outline: none; transition: border-color 0.2s; }
        .input:focus { border-color: var(--lucas-green); }
        .input::placeholder { color: var(--text-muted); }
        
        /* Cards */
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 20px; }
        
        /* Sidebar */
        .sidebar { width: 260px; height: 100vh; background: var(--bg-card); border-right: 1px solid var(--border); position: fixed; left: 0; top: 0; padding: 24px; display: flex; flex-direction: column; }
        .sidebar-logo { display: flex; align-items: center; gap: 12px; margin-bottom: 40px; }
        .sidebar-logo img { width: 40px; height: 40px; border-radius: 10px; }
        .sidebar-logo h1 { font-size: 24px; font-weight: 800; }
        .sidebar-nav { flex: 1; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 14px 16px; border-radius: 10px; color: var(--text-light); cursor: pointer; transition: all 0.2s; margin-bottom: 4px; }
        .nav-item:hover { background: var(--bg-card-hover); color: white; }
        .nav-item.active { background: rgba(222,255,154,0.1); color: var(--lucas-green); }
        .nav-item i { width: 20px; text-align: center; }
        
        /* Main Content */
        .main { margin-left: 260px; padding: 32px; min-height: 100vh; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; }
        .page-title { font-size: 28px; font-weight: 700; }
        
        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 32px; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 24px; }
        .stat-label { font-size: 13px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        .stat-value { font-size: 36px; font-weight: 800; }
        .stat-value.green { color: var(--lucas-green); }
        
        /* Table */
        .table-container { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; }
        .table-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--border); }
        .table-title { font-size: 18px; font-weight: 700; }
        .table-filters { display: flex; gap: 12px; }
        .filter-btn { padding: 8px 16px; background: var(--bg-card-hover); border: 1px solid var(--border); border-radius: 8px; color: var(--text-light); cursor: pointer; font-family: inherit; font-size: 13px; transition: all 0.2s; }
        .filter-btn:hover, .filter-btn.active { border-color: var(--lucas-green); color: var(--lucas-green); }
        
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 16px 24px; font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--border); }
        td { padding: 16px 24px; border-bottom: 1px solid var(--border); }
        tr:hover { background: var(--bg-card-hover); }
        
        .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .badge-retail { background: rgba(222,255,154,0.15); color: var(--lucas-green); }
        .badge-mapeo { background: rgba(96,165,250,0.15); color: #60a5fa; }
        .badge-kyb { background: rgba(244,114,182,0.15); color: #f472b6; }
        .badge-approved { background: rgba(34,197,94,0.15); color: #22c55e; }
        .badge-pending { background: rgba(251,191,36,0.15); color: #fbbf24; }
        .badge-rejected { background: rgba(239,68,68,0.15); color: #ef4444; }
        
        .submission-thumb { width: 60px; height: 45px; border-radius: 8px; object-fit: cover; cursor: pointer; transition: transform 0.2s; }
        .submission-thumb:hover { transform: scale(1.1); }
        
        /* Map */
        #map { height: 500px; border-radius: 12px; }
        .leaflet-popup-content-wrapper { background: var(--bg-card); color: white; border-radius: 12px; }
        .leaflet-popup-tip { background: var(--bg-card); }
        
        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 24px; border-bottom: 1px solid var(--border); }
        .modal-title { font-size: 20px; font-weight: 700; }
        .modal-close { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 24px; }
        .modal-body { padding: 24px; }
        .modal-footer { padding: 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; }
        
        /* Form */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 14px; color: var(--text-light); margin-bottom: 8px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        select.input { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M6 8L1 3h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 16px center; }
        textarea.input { min-height: 100px; resize: vertical; }
        
        /* Image Modal */
        .image-modal img { width: 100%; border-radius: 12px; }
        .image-meta { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 20px; }
        .meta-item { background: var(--bg-card-hover); padding: 16px; border-radius: 10px; }
        .meta-label { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
        .meta-value { font-size: 14px; font-weight: 600; }
        
        /* Login */
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; background: radial-gradient(ellipse at center, rgba(222,255,154,0.05) 0%, transparent 50%); }
        .login-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 24px; padding: 48px; width: 100%; max-width: 420px; text-align: center; }
        .login-logo { width: 80px; height: 80px; margin: 0 auto 24px; border-radius: 20px; }
        .login-title { font-size: 28px; font-weight: 800; margin-bottom: 8px; }
        .login-subtitle { color: var(--text-muted); margin-bottom: 32px; }
        
        /* Responsive */
        @media (max-width: 1200px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { 
            .sidebar { display: none; } 
            .main { margin-left: 0; padding: 20px; } 
            .stats-grid { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // Supabase Config
        const SUPABASE_URL = 'https://irztntmenxchzicfegid.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlyenRudG1lbnhjaHppY2ZlZ2lkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxMTA4ODQsImV4cCI6MjA3OTY4Njg4NH0.EjaO-HXjzElo_eHqEWzagsqGg-gEVqUxY1ri-MhofPw';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Client passwords (simple auth for pilot)
        const CLIENT_PASSWORDS = {
            'lucas2025': { name: 'LUCAS Admin', role: 'admin' },
            'pilot2025': { name: 'Pilot Client', role: 'client' }
        };
        
        // Login Screen
        function LoginScreen({ onLogin }) {
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            
            const handleSubmit = (e) => {
                e.preventDefault();
                setIsLoading(true);
                setError('');
                
                setTimeout(() => {
                    const client = CLIENT_PASSWORDS[password];
                    if (client) {
                        localStorage.setItem('lucas_dashboard', JSON.stringify(client));
                        onLogin(client);
                    } else {
                        setError('Invalid password');
                    }
                    setIsLoading(false);
                }, 500);
            };
            
            return (
                <div className="login-container fade-in">
                    <div className="login-card">
                        <img src="https://lucas-app.github.io/lucas-pwa/icon-512.png" alt="LUCAS" className="login-logo" />
                        <h1 className="login-title">LUCAS</h1>
                        <p className="login-subtitle">Client Dashboard</p>
                        
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <input 
                                    type="password" 
                                    className="input" 
                                    placeholder="Enter password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    style={{ textAlign: 'center' }}
                                />
                            </div>
                            
                            {error && <p style={{ color: '#ef4444', marginBottom: '16px', fontSize: '14px' }}>{error}</p>}
                            
                            <button type="submit" className="btn btn-primary" style={{ width: '100%', justifyContent: 'center' }} disabled={isLoading}>
                                {isLoading ? <div className="spinner" style={{ width: '20px', height: '20px', borderWidth: '2px' }}></div> : 'Access Dashboard'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }
        
        // Sidebar
        function Sidebar({ activeTab, setActiveTab, client, onLogout }) {
            const navItems = [
                { id: 'overview', icon: 'fa-chart-line', label: 'Overview' },
                { id: 'submissions', icon: 'fa-images', label: 'Submissions' },
                { id: 'tasks', icon: 'fa-list-check', label: 'Tasks' },
                { id: 'map', icon: 'fa-map-location-dot', label: 'Map View' },
                { id: 'agents', icon: 'fa-users', label: 'Agents' },
            ];
            
            return (
                <div className="sidebar">
                    <div className="sidebar-logo">
                        <img src="https://lucas-app.github.io/lucas-pwa/icon-512.png" alt="LUCAS" />
                        <h1>LUCAS</h1>
                    </div>
                    
                    <nav className="sidebar-nav">
                        {navItems.map(item => (
                            <div 
                                key={item.id}
                                className={`nav-item ${activeTab === item.id ? 'active' : ''}`}
                                onClick={() => setActiveTab(item.id)}
                            >
                                <i className={`fa-solid ${item.icon}`}></i>
                                <span>{item.label}</span>
                            </div>
                        ))}
                    </nav>
                    
                    <div style={{ borderTop: '1px solid var(--border)', paddingTop: '20px' }}>
                        <div style={{ fontSize: '14px', color: 'var(--text-muted)', marginBottom: '8px' }}>Logged in as</div>
                        <div style={{ fontWeight: '600', marginBottom: '16px' }}>{client.name}</div>
                        <button onClick={onLogout} className="btn btn-secondary btn-sm" style={{ width: '100%', justifyContent: 'center' }}>
                            <i className="fa-solid fa-right-from-bracket"></i> Logout
                        </button>
                    </div>
                </div>
            );
        }
        
        // Overview Tab
        function OverviewTab({ stats, submissions }) {
            return (
                <div className="fade-in">
                    <div className="page-header">
                        <h1 className="page-title">Overview</h1>
                        <div style={{ color: 'var(--text-muted)', fontSize: '14px' }}>
                            <i className="fa-solid fa-circle" style={{ color: '#22c55e', fontSize: '8px', marginRight: '8px' }}></i>
                            Pilot Active â€” CDMX
                        </div>
                    </div>
                    
                    <div className="stats-grid">
                        <div className="stat-card">
                            <div className="stat-label">Total Submissions</div>
                            <div className="stat-value">{stats.totalSubmissions}</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-label">Approved</div>
                            <div className="stat-value green">{stats.approved}</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-label">Pending Review</div>
                            <div className="stat-value" style={{ color: '#fbbf24' }}>{stats.pending}</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-label">Total Paid</div>
                            <div className="stat-value green">${stats.totalPaid.toFixed(2)}</div>
                        </div>
                    </div>
                    
                    <div className="table-container">
                        <div className="table-header">
                            <h3 className="table-title">Recent Submissions</h3>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Photo</th>
                                    <th>Task</th>
                                    <th>Type</th>
                                    <th>Agent</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {submissions.slice(0, 5).map(sub => (
                                    <tr key={sub.id}>
                                        <td>
                                            {sub.image_url ? (
                                                <img src={sub.image_url} className="submission-thumb" alt="Submission" />
                                            ) : (
                                                <div style={{ width: '60px', height: '45px', background: 'var(--bg-card-hover)', borderRadius: '8px', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                                                    <i className="fa-solid fa-image" style={{ color: 'var(--text-muted)' }}></i>
                                                </div>
                                            )}
                                        </td>
                                        <td>{sub.tasks?.title || 'N/A'}</td>
                                        <td><span className={`badge badge-${(sub.tasks?.type || 'retail').toLowerCase()}`}>{sub.tasks?.type || 'N/A'}</span></td>
                                        <td>{sub.agents?.name || 'Unknown'}</td>
                                        <td><span className={`badge badge-${sub.status}`}>{sub.status}</span></td>
                                        <td style={{ color: 'var(--text-muted)' }}>{new Date(sub.created_at).toLocaleDateString()}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }
        
        // Submissions Tab
        function SubmissionsTab({ submissions, onViewImage, onUpdateStatus }) {
            const [filter, setFilter] = useState('all');
            
            const filtered = filter === 'all' ? submissions : submissions.filter(s => s.status === filter);
            
            return (
                <div className="fade-in">
                    <div className="page-header">
                        <h1 className="page-title">Submissions</h1>
                        <button className="btn btn-secondary" onClick={() => {
                            const csv = ['ID,Task,Type,Agent,GPS,Status,Date,Image URL']
                                .concat(submissions.map(s => 
                                    `${s.id},"${s.tasks?.title}",${s.tasks?.type},"${s.agents?.name}","${s.gps_lat},${s.gps_lng}",${s.status},${s.created_at},${s.image_url || ''}`
                                )).join('\n');
                            const blob = new Blob([csv], { type: 'text/csv' });
                            const a = document.createElement('a');
                            a.href = URL.createObjectURL(blob);
                            a.download = 'lucas-submissions.csv';
                            a.click();
                        }}>
                            <i className="fa-solid fa-download"></i> Export CSV
                        </button>
                    </div>
                    
                    <div className="table-container">
                        <div className="table-header">
                            <h3 className="table-title">{filtered.length} submissions</h3>
                            <div className="table-filters">
                                {['all', 'approved', 'pending', 'rejected'].map(f => (
                                    <button key={f} className={`filter-btn ${filter === f ? 'active' : ''}`} onClick={() => setFilter(f)}>
                                        {f.charAt(0).toUpperCase() + f.slice(1)}
                                    </button>
                                ))}
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Photo</th>
                                    <th>Task</th>
                                    <th>Type</th>
                                    <th>Agent</th>
                                    <th>GPS</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filtered.map(sub => (
                                    <tr key={sub.id}>
                                        <td>
                                            {sub.image_url ? (
                                                <img src={sub.image_url} className="submission-thumb" alt="Submission" onClick={() => onViewImage(sub)} />
                                            ) : (
                                                <div style={{ width: '60px', height: '45px', background: 'var(--bg-card-hover)', borderRadius: '8px', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                                                    <i className="fa-solid fa-image" style={{ color: 'var(--text-muted)' }}></i>
                                                </div>
                                            )}
                                        </td>
                                        <td style={{ maxWidth: '200px' }}>{sub.tasks?.title || 'N/A'}</td>
                                        <td><span className={`badge badge-${(sub.tasks?.type || 'retail').toLowerCase()}`}>{sub.tasks?.type || 'N/A'}</span></td>
                                        <td>{sub.agents?.name || 'Unknown'}</td>
                                        <td style={{ fontSize: '12px', color: 'var(--text-muted)' }}>{sub.gps_lat?.toFixed(4)}, {sub.gps_lng?.toFixed(4)}</td>
                                        <td><span className={`badge badge-${sub.status}`}>{sub.status}</span></td>
                                        <td style={{ color: 'var(--text-muted)', fontSize: '13px' }}>{new Date(sub.created_at).toLocaleString()}</td>
                                        <td>
                                            <div style={{ display: 'flex', gap: '8px' }}>
                                                {sub.status === 'pending' && (
                                                    <>
                                                        <button className="btn btn-icon btn-secondary" title="Approve" onClick={() => onUpdateStatus(sub.id, 'approved')} style={{ color: '#22c55e' }}>
                                                            <i className="fa-solid fa-check"></i>
                                                        </button>
                                                        <button className="btn btn-icon btn-secondary" title="Reject" onClick={() => onUpdateStatus(sub.id, 'rejected')} style={{ color: '#ef4444' }}>
                                                            <i className="fa-solid fa-xmark"></i>
                                                        </button>
                                                    </>
                                                )}
                                                <button className="btn btn-icon btn-secondary" title="View" onClick={() => onViewImage(sub)}>
                                                    <i className="fa-solid fa-eye"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }
        
        // Tasks Tab
        function TasksTab({ tasks, onAddTask, onDeleteTask }) {
            const [showModal, setShowModal] = useState(false);
            const [newTask, setNewTask] = useState({ type: 'RETAIL', title: '', location: '', address: '', lat: '', lng: '', payout: '', instructions: '', estimated_time: '5-10 min' });
            const [isSubmitting, setIsSubmitting] = useState(false);
            
            const handleSubmit = async () => {
                setIsSubmitting(true);
                const instructionsArray = newTask.instructions.split('\n').filter(i => i.trim());
                await onAddTask({
                    ...newTask,
                    lat: parseFloat(newTask.lat),
                    lng: parseFloat(newTask.lng),
                    payout: parseFloat(newTask.payout),
                    instructions: instructionsArray
                });
                setNewTask({ type: 'RETAIL', title: '', location: '', address: '', lat: '', lng: '', payout: '', instructions: '', estimated_time: '5-10 min' });
                setShowModal(false);
                setIsSubmitting(false);
            };
            
            return (
                <div className="fade-in">
                    <div className="page-header">
                        <h1 className="page-title">Tasks</h1>
                        <button className="btn btn-primary" onClick={() => setShowModal(true)}>
                            <i className="fa-solid fa-plus"></i> Add Task
                        </button>
                    </div>
                    
                    <div className="table-container">
                        <div className="table-header">
                            <h3 className="table-title">{tasks.length} tasks</h3>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Type</th>
                                    <th>Location</th>
                                    <th>Payout</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {tasks.map(task => (
                                    <tr key={task.id}>
                                        <td style={{ fontWeight: 600 }}>{task.title}</td>
                                        <td><span className={`badge badge-${task.type.toLowerCase()}`}>{task.type}</span></td>
                                        <td>
                                            <div>{task.location}</div>
                                            <div style={{ fontSize: '12px', color: 'var(--text-muted)' }}>{task.address}</div>
                                        </td>
                                        <td style={{ fontWeight: 700, color: 'var(--lucas-green)' }}>${Number(task.payout).toFixed(2)}</td>
                                        <td><span className={`badge badge-${task.status === 'available' ? 'approved' : 'pending'}`}>{task.status}</span></td>
                                        <td>
                                            <button className="btn btn-icon btn-secondary" onClick={() => onDeleteTask(task.id)} title="Delete">
                                                <i className="fa-solid fa-trash" style={{ color: '#ef4444' }}></i>
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    
                    {showModal && (
                        <div className="modal-overlay" onClick={() => setShowModal(false)}>
                            <div className="modal" onClick={e => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h3 className="modal-title">Add New Task</h3>
                                    <button className="modal-close" onClick={() => setShowModal(false)}>&times;</button>
                                </div>
                                <div className="modal-body">
                                    <div className="form-row">
                                        <div className="form-group">
                                            <label className="form-label">Type</label>
                                            <select className="input" value={newTask.type} onChange={e => setNewTask({...newTask, type: e.target.value})}>
                                                <option value="RETAIL">RETAIL</option>
                                                <option value="MAPEO">MAPEO</option>
                                                <option value="KYB">KYB</option>
                                            </select>
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Payout (USDT)</label>
                                            <input className="input" type="number" step="0.5" placeholder="2.50" value={newTask.payout} onChange={e => setNewTask({...newTask, payout: e.target.value})} />
                                        </div>
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Title</label>
                                        <input className="input" placeholder="Verificar Stock Coca-Cola" value={newTask.title} onChange={e => setNewTask({...newTask, title: e.target.value})} />
                                    </div>
                                    <div className="form-row">
                                        <div className="form-group">
                                            <label className="form-label">Location Name</label>
                                            <input className="input" placeholder="OXXO Polanco" value={newTask.location} onChange={e => setNewTask({...newTask, location: e.target.value})} />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Estimated Time</label>
                                            <input className="input" placeholder="5-10 min" value={newTask.estimated_time} onChange={e => setNewTask({...newTask, estimated_time: e.target.value})} />
                                        </div>
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Full Address</label>
                                        <input className="input" placeholder="Av. Presidente Masaryk 456, Polanco" value={newTask.address} onChange={e => setNewTask({...newTask, address: e.target.value})} />
                                    </div>
                                    <div className="form-row">
                                        <div className="form-group">
                                            <label className="form-label">Latitude</label>
                                            <input className="input" type="number" step="0.0001" placeholder="19.4326" value={newTask.lat} onChange={e => setNewTask({...newTask, lat: e.target.value})} />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">Longitude</label>
                                            <input className="input" type="number" step="0.0001" placeholder="-99.1892" value={newTask.lng} onChange={e => setNewTask({...newTask, lng: e.target.value})} />
                                        </div>
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Instructions (one per line)</label>
                                        <textarea className="input" placeholder="Step 1&#10;Step 2&#10;Step 3" value={newTask.instructions} onChange={e => setNewTask({...newTask, instructions: e.target.value})}></textarea>
                                    </div>
                                </div>
                                <div className="modal-footer">
                                    <button className="btn btn-secondary" onClick={() => setShowModal(false)}>Cancel</button>
                                    <button className="btn btn-primary" onClick={handleSubmit} disabled={isSubmitting}>
                                        {isSubmitting ? 'Adding...' : 'Add Task'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        
        // Map Tab
        function MapTab({ submissions }) {
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            
            useEffect(() => {
                if (!mapRef.current || mapInstanceRef.current) return;
                
                // Initialize map centered on CDMX
                const map = L.map(mapRef.current).setView([19.4326, -99.1332], 12);
                mapInstanceRef.current = map;
                
                // Dark theme tiles
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
                }).addTo(map);
                
                // Add markers for submissions
                submissions.forEach(sub => {
                    if (sub.gps_lat && sub.gps_lng) {
                        const marker = L.circleMarker([sub.gps_lat, sub.gps_lng], {
                            radius: 8,
                            fillColor: sub.status === 'approved' ? '#deff9a' : sub.status === 'pending' ? '#fbbf24' : '#ef4444',
                            color: '#050505',
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 0.9
                        }).addTo(map);
                        
                        marker.bindPopup(`
                            <div style="min-width: 200px;">
                                ${sub.image_url ? `<img src="${sub.image_url}" style="width: 100%; border-radius: 8px; margin-bottom: 8px;">` : ''}
                                <div style="font-weight: 600; margin-bottom: 4px;">${sub.tasks?.title || 'Task'}</div>
                                <div style="font-size: 12px; color: #9ca3af;">Agent: ${sub.agents?.name || 'Unknown'}</div>
                                <div style="font-size: 12px; color: #9ca3af;">${new Date(sub.created_at).toLocaleString()}</div>
                            </div>
                        `);
                    }
                });
                
                return () => {
                    if (mapInstanceRef.current) {
                        mapInstanceRef.current.remove();
                        mapInstanceRef.current = null;
                    }
                };
            }, [submissions]);
            
            return (
                <div className="fade-in">
                    <div className="page-header">
                        <h1 className="page-title">Map View</h1>
                        <div style={{ display: 'flex', gap: '16px', alignItems: 'center' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                <div style={{ width: '12px', height: '12px', borderRadius: '50%', background: '#deff9a' }}></div>
                                <span style={{ fontSize: '13px', color: 'var(--text-muted)' }}>Approved</span>
                            </div>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                <div style={{ width: '12px', height: '12px', borderRadius: '50%', background: '#fbbf24' }}></div>
                                <span style={{ fontSize: '13px', color: 'var(--text-muted)' }}>Pending</span>
                            </div>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                <div style={{ width: '12px', height: '12px', borderRadius: '50%', background: '#ef4444' }}></div>
                                <span style={{ fontSize: '13px', color: 'var(--text-muted)' }}>Rejected</span>
                            </div>
                        </div>
                    </div>
                    
                    <div className="card">
                        <div id="map" ref={mapRef}></div>
                    </div>
                </div>
            );
        }
        
        // Agents Tab
        function AgentsTab({ agents }) {
            return (
                <div className="fade-in">
                    <div className="page-header">
                        <h1 className="page-title">Agents</h1>
                    </div>
                    
                    <div className="table-container">
                        <div className="table-header">
                            <h3 className="table-title">{agents.length} registered agents</h3>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Colonia</th>
                                    <th>Tasks Completed</th>
                                    <th>Balance</th>
                                    <th>Joined</th>
                                </tr>
                            </thead>
                            <tbody>
                                {agents.map(agent => (
                                    <tr key={agent.id}>
                                        <td style={{ fontWeight: 600 }}>{agent.name}</td>
                                        <td style={{ color: 'var(--text-muted)' }}>{agent.phone}</td>
                                        <td>{agent.colonia || '-'}</td>
                                        <td style={{ fontWeight: 700, color: 'var(--lucas-green)' }}>{agent.completed_tasks || 0}</td>
                                        <td style={{ fontWeight: 700 }}>${Number(agent.balance || 0).toFixed(2)}</td>
                                        <td style={{ color: 'var(--text-muted)', fontSize: '13px' }}>{new Date(agent.created_at).toLocaleDateString()}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }
        
        // Image Modal
        function ImageModal({ submission, onClose }) {
            if (!submission) return null;
            
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal image-modal" onClick={e => e.stopPropagation()} style={{ maxWidth: '700px' }}>
                        <div className="modal-header">
                            <h3 className="modal-title">{submission.tasks?.title || 'Submission'}</h3>
                            <button className="modal-close" onClick={onClose}>&times;</button>
                        </div>
                        <div className="modal-body">
                            {submission.image_url && <img src={submission.image_url} alt="Submission" />}
                            <div className="image-meta">
                                <div className="meta-item">
                                    <div className="meta-label">GPS Coordinates</div>
                                    <div className="meta-value">{submission.gps_lat?.toFixed(6)}, {submission.gps_lng?.toFixed(6)}</div>
                                </div>
                                <div className="meta-item">
                                    <div className="meta-label">Timestamp</div>
                                    <div className="meta-value">{new Date(submission.created_at).toLocaleString()}</div>
                                </div>
                                <div className="meta-item">
                                    <div className="meta-label">Agent</div>
                                    <div className="meta-value">{submission.agents?.name || 'Unknown'}</div>
                                </div>
                                <div className="meta-item">
                                    <div className="meta-label">Status</div>
                                    <div className="meta-value"><span className={`badge badge-${submission.status}`}>{submission.status}</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }
        
        // Main App
        function App() {
            const [client, setClient] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('overview');
            const [submissions, setSubmissions] = useState([]);
            const [tasks, setTasks] = useState([]);
            const [agents, setAgents] = useState([]);
            const [selectedSubmission, setSelectedSubmission] = useState(null);
            
            // Check session
            useEffect(() => {
                const saved = localStorage.getItem('lucas_dashboard');
                if (saved) setClient(JSON.parse(saved));
                setIsLoading(false);
            }, []);
            
            // Fetch data
            const fetchData = async () => {
                const [subsRes, tasksRes, agentsRes] = await Promise.all([
                    supabase.from('submissions').select('*, tasks(*), agents(*)').order('created_at', { ascending: false }),
                    supabase.from('tasks').select('*').order('created_at', { ascending: false }),
                    supabase.from('agents').select('*').order('created_at', { ascending: false })
                ]);
                
                if (subsRes.data) setSubmissions(subsRes.data);
                if (tasksRes.data) setTasks(tasksRes.data);
                if (agentsRes.data) setAgents(agentsRes.data);
            };
            
            useEffect(() => {
                if (client) fetchData();
            }, [client]);
            
            // Stats
            const stats = {
                totalSubmissions: submissions.length,
                approved: submissions.filter(s => s.status === 'approved').length,
                pending: submissions.filter(s => s.status === 'pending').length,
                totalPaid: submissions.filter(s => s.status === 'approved').reduce((sum, s) => sum + Number(s.payout || 0), 0)
            };
            
            // Handlers
            const handleUpdateStatus = async (id, status) => {
                await supabase.from('submissions').update({ status }).eq('id', id);
                fetchData();
            };
            
            const handleAddTask = async (task) => {
                await supabase.from('tasks').insert([{ ...task, status: 'available' }]);
                fetchData();
            };
            
            const handleDeleteTask = async (id) => {
                if (confirm('Delete this task?')) {
                    await supabase.from('tasks').delete().eq('id', id);
                    fetchData();
                }
            };
            
            const handleLogout = () => {
                localStorage.removeItem('lucas_dashboard');
                setClient(null);
            };
            
            if (isLoading) {
                return <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', minHeight: '100vh' }}><div className="spinner"></div></div>;
            }
            
            if (!client) {
                return <LoginScreen onLogin={setClient} />;
            }
            
            return (
                <div>
                    <Sidebar activeTab={activeTab} setActiveTab={setActiveTab} client={client} onLogout={handleLogout} />
                    
                    <main className="main">
                        {activeTab === 'overview' && <OverviewTab stats={stats} submissions={submissions} />}
                        {activeTab === 'submissions' && <SubmissionsTab submissions={submissions} onViewImage={setSelectedSubmission} onUpdateStatus={handleUpdateStatus} />}
                        {activeTab === 'tasks' && <TasksTab tasks={tasks} onAddTask={handleAddTask} onDeleteTask={handleDeleteTask} />}
                        {activeTab === 'map' && <MapTab submissions={submissions} />}
                        {activeTab === 'agents' && <AgentsTab agents={agents} />}
                    </main>
                    
                    {selectedSubmission && <ImageModal submission={selectedSubmission} onClose={() => setSelectedSubmission(null)} />}
                </div>
            );
        }
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
